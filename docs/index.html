<!DOCTYPE html>
<html> 
<head>
    <meta charset='utf-8' />
    <title>Mapbox Storytelling</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/mapbox/assembly/publisher-staging/src/svgs/mapbox.svg">
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@600;800&display=swap" rel="stylesheet">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/intersection-observer@0.12.0/intersection-observer.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://unpkg.com/scrollama"></script>
    <style>
        /* Add a new class to control visibility of the exposition */
        .exposition-hidden {
            display: none;
        }
        /* Sticky positioning for the exposition */
        #exposition {
            background-image: url('https://github.com/madgallop/jaffa-oranges/blob/main/docs/images/landing_place.jpg?raw=true');
            background-size: 60% auto; /* Makes the background image slightly smaller */
            background-origin: content-box; /* Preserves the background color within padding */
            background-clip: content-box; /* Applies the background within the padding */
            background-position: center;
            background-color: #f6f3eeb7; 
            background-repeat: no-repeat; /* Prevents the background image from repeating */
            background-attachment: fixed; /* Fixes the background position */
            text-align: center; /* Center the text */
            font-family: 'EB Garamond', serif; /* Use EB Garamond font */
            box-sizing: border-box;
            height: 96vh; /* Set the height to half the viewport height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 1000;
        }
        #map-container {
            position: flex;
            width: 100%;
            top: 0; 
            height: 100vh; /* Occupy the remaining viewport height */
            transition: height 0.3s ease; /* Add transition for smooth height change */
        }
        body {
            margin:0;
            padding:0;
            font-family: 'Avenir', sans-serif;
            font-weight: normal;
            opacity: 1;
            color: #4d4d4dec;
            text-align: justify;
        }
        #map {
            height: 100vh;
            width: 100%;
            position: absolute; /* Change to relative for proper placement */
            z-index: 0;
        }
        /* Adjustments for the exposition text */

        /* Font for title and subtitle */
        .h1-text{
            color: rgb(119, 118, 118);
            position: absolute;
            top: 0;
            left: 20.5%;
            padding: 2vh 1vw; /* Adjust the padding as needed */
            font-size: 22px; /* Adjust the font size as needed */
            text-align: center;
            font-weight: bold;
            font-family: 'EB+Garamond', serif;
            letter-spacing: 5px;
        }
        .p1-text{
            color: rgb(119, 118, 118);
            max-width: 30vh;
            position: absolute;
            top: 16vh;
            left: 5vh;
            padding: 8vh 7vw; /* Adjust the padding as needed */
            max-width: 50vh; /* Set the maximum width to 50% */
            margin: 0 auto; /* Center the element horizontally */
            font-size: 18px; /* Adjust the font size as needed */
            text-align: center;
            float:left;
            font-family: 'EB+Garamond', serif; /* Use correct font name */
            letter-spacing: 1px; 
            background-color: #dddbc8e0;
        }
        .p3-text {
            margin: 0;
            position:absolute;
            top:40vh;
            right: 7vh;
            color: rgb(119, 118, 118);
            max-width: 30vh;
            padding: 5vh 8vw;
            font-size: 17px; /* Adjust the font size as needed */
            text-align: center;
            float: right;
            font-family: 'EB+Garamond', serif;
            font-weight: lighter;
            background-color:#e7c094d7;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from {
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.9), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.9);
            }
        }
        /* Font for chapters */
        .step h3 {
            font-family: 'Avenir', sans-serif;
            font-weight: normal;
            color: rgb(136, 136, 136);
            margin: 0;
            padding: 0.5vh 0.2vw; /* Adjust the padding as needed */
            text-align: left;
            font-size: 15px;
            width: 50%; /* Set the width to 50% */
            text-align: left;
            letter-spacing: 0px; 
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        /* Active class for fade-in */
        .step.active h3 {
            transition: opacity 1s ease;
            opacity: 1;
        }
        #timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100vw;
            margin: 60px 5px;
            position: fixed;
            bottom: 0;
            z-index: 2;
        }
        .timeline-marker {
            background: #EFBF8F;
            width: 20px;
            margin: 10px 25px;
            height: 20px;
            border-radius: 50vw;
            cursor: pointer;
            text-align: center;
            font-size: 15px;
            font-family: 'EB+Garamond', serif;
            color: rgb(119, 118, 118);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 2;
        }
        .timeline-marker:hover {
            background: #f6a14c;
        }
        /* Example CSS to highlight the active timeline marker */
        .timeline-marker.active-timeline-marker {
            background-color: #f9912a; /* Change the color as desired */
            /* Add any other styles to visually highlight the active marker */
        }
        .text-container {
            background-color: rgba(238, 237, 237, 0); /* Background color for the text */
            padding: 10px; /* Adjust the padding as needed */
            border-radius: 0; /* Adjust border radius as needed */
            z-index: -1;
        }
        .timeline-line {
            position: fixed;
            background-color: #EFBF8F;
            height: 3px; /* Adjust the height of the line as needed */
            width: calc(100% - 75px); /* Width of the line is the container width minus marker margins */
            transform: translateY(-1px); /* Center the line vertically */
            left: 20px;
            right:10px;
            margin: 10px 25px;
            z-index: 0; /* Place the line behind markers */
        }
        .timeline-marker:nth-child(1) {
            left: 0%;
        }

        .timeline-marker:nth-child(2) {
            left: 40%;
        }

        .timeline-marker:nth-child(3) {
            left: 65%;
        }

        .timeline-marker:nth-child(4) {
            left: 100%;
        }
        
        #scale-bar {
            position: fixed;
            bottom: 0;            
            margin: 3px 140px;
            background: rgba(255, 255, 255, 0);
            border: 2px solid #EFBF8F;
            padding: 5px 27px;
            font-size: 12px;
            font-family: 'EB+Garamond', serif;
            color: rgb(119, 118, 118);
        }
        #mapInset {
            bottom:50px;
            right:30px;
            height: 80px; /* Example height */
            width: 120px; /* Example width */
            max-width:100%;
            position: fixed;
            z-index: 1;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            display: none;
        }
        #insetCanvas {
            position: absolute;
            top: 68vh;
            left: 3vh; 
            height: auto;
            width: 300px;
            border: 1px solid #ccc;
            float:right;
            opacity: 0.9;
            image-rendering: optimizeSpeed; /* Optimize rendering speed */
        }
        .inset-map {
            width: 100%; /* Set width to 100% */
            text-align: right; /* Center the image horizontally */
            padding: 20px; /* Add padding as needed */
            float:right;
        }
        #inset-map-image {
            max-width: 100%; /* Ensure the image doesn't exceed its container */
            max-height: 100%; /* Ensure the image doesn't exceed its container */
            width: auto; /* Allow the image to adjust its width */
            height: auto; /* Allow the image to adjust its height */
            border: 1px solid #ccc; /* Optional: Add border for visibility */
            float: right;
        /* You can adjust other styles as needed */
        }

        /* #mapInset .mapboxgl-ctrl-bottom-left{
            display: none;
        }
        @media (max-width: 500px) {
            #mapInset {
                display: none;
            }
        } */
        #footer {
            width: 100%;
            min-height: 5vh;
            padding-top: 2vh;
            padding-bottom: 2vh;
            text-align: center;
            line-height: 25px;
            font-size: 13px;
            position: relative;
            z-index: 5;
        }
        #glowingTextBox {
            position: fixed;
            max-width: 13%;
            top: 150px; /* Adjust the top position */
            right: 1vw; /* Adjust the position based on screen width */
            z-index: 9999;
            padding: 10px;
            background-color: rgba(246, 243, 238, 0.761);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            pointer-events: none;
            text-align: center;
            font-size: 14px;
            font-family: 'Avenir', sans-serif;
            font-weight: 50;
            color: rgb(119, 118, 118);
            /* Other styles */
        }
        .glow-visible {
            opacity: 1; /* Make the box visible when this class is added */
            pointer-events: auto; /* Enable interactions when visible */
        }
        .glow-hidden {
            opacity: 0; /* Make the box visible when this class is added */
            pointer-events: none; /* Enable interactions when visible */
        }
        #features {
            padding-top: 10vh;
            padding-bottom: 10vh;
        }
        .hidden {
            visibility: hidden;
        }
        .centered {
            width: 50vw;
            margin: 0 auto;
        }
        .lefty {
            width: 33vw;
            margin-left: 2vw;
        }
        .righty {
            width: 33vw;
            margin-left: 62vw;
        }
        .fully {
            width: 100%;
            margin: auto;
        }
        .light {
            color: #444;
            background-color: #fafafa00;
        }
        .dark {
            color: #fafafa;
            background-color: #444;
        }
        .step {
            padding-bottom: 50vh;
            /* margin-bottom: 10vh; */
            opacity: 0;
            transition: opacity 1s ease; /* Add transition effect over 2 seconds */
        }
        .step.active {
            transition: opacity 1s ease-in-out;
            opacity: 0.9;
        }

        .step div {
            padding:  25px 0px;
            line-height: 25px;
            font-size: 15px;
        }

        .step img {
            width: 100%;
        }

        @media (max-width: 750px) {
            .centered, .lefty, .righty, .fully {
                display: none;
                width: 90vw;
                margin: 0 auto;
            }
        }

        /* Fix issue on mobile browser where scroll breaks  */
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan .mapboxgl-canvas {
            touch-action: unset;
        }

        </style>
</head>
<body>

<div id="exposition" class="exposition-hidden">
    <div class="title-text">
        <h1 class="h1-text">THE PERFECT BITE:<br> COLLABORATION AND DISPOSSESSION IN JAFFA, PALESTINE</h1>
        <p class="p1-text">The Jaffa orange is a powerful and contested symbol of identity. Originating in Jaffa, historically known as the 'gateway to Palestine,' the Shamouti orange emerged from the labor and innovation of Palestinian farmers during the mid-19th century. This unusually thick and nearly seedless fruit became synonymous with Jaffa's production and export. Its narrative mirrors the tumultuous history of the land itself. The story of Jaffa's dispossession—of industry, land, and of identity—resonates with the plight of dozens of Palestinian towns. Once a symbol of Palestinian prowess and pride in cultivation, the orange now embodies loss and estrangement. <br><br>The map below explores the story of cultivation, collaboration, and loss in Palestine through focusing on the Jaffa orange industry, from its inception to its eventual decline in the late 20th century.</p>
        <canvas id="insetCanvas"></canvas>
        <p class="p3-text">Scroll to view the story or click one of the defining periods on the timeline below.<br><br>Click on an orange grove to access primary source commentary specific to that period. Click again to hide the details.<br><br><i>Circle radii visually depict the proportion of acres dedicated to Jaffa orange groves in relation to the total boxes of Jaffa oranges exported for a given year.<br><br>Green text represents the portion of land owned by Palestinians, while blue text indicates the portion under Jewish/Israeli ownership.</i></p>
    </div>
</div>
<div id="glowingTextBox" class="glow-hidden"></div>
<div id="map-container">
    <div id="map"></div>
</div>
<div id="scale-bar" class="mapboxgl-ctrl mapboxgl-ctrl-scale">
    <span>1km</span>
</div>
<div id="timeline">
    <div class="timeline-marker" data-chapter="0">
        <div class="text-container">
            <p id="chapter-1-text">Palestinian Period</p>
        </div>
    </div>
    <div class="timeline-marker" data-chapter="1">
        <div class="text-container">
            <p id="chapter-1-text">Collaborative Period</p>
        </div>
    </div>
    <div class="timeline-marker" data-chapter="2">
        <div class="text-container">
            <p id="chapter-1-text">Israeli Period</p>
        </div>
    </div>
    <div class="timeline-marker" data-chapter="3">
        <div class="text-container">
            <p id="chapter-1-text">Decline</p>
        </div>
    </div>
    <div class="timeline-line"></div>
</div>
<div id="mapInset"></div>
<div id="story"></div>
  

<script src="./config.js"></script>
<script>
var initLoad = true;
var layerTypes = {
    'fill': ['fill-opacity'],
    'line': ['line-opacity'],
    'circle': ['circle-opacity', 'circle-stroke-opacity'],
    'symbol': ['icon-opacity', 'text-opacity'],
    'raster': ['raster-opacity'],
    'fill-extrusion': ['fill-extrusion-opacity'],
    'heatmap': ['heatmap-opacity']
}

var alignments = {
    'left': 'lefty',
    'center': 'centered',
    'right': 'righty',
    'full': 'fully'
}

function getLayerPaintType(layer) {
    var layerType = map.getLayer(layer).type;
    return layerTypes[layerType];
}

function setLayerOpacity(layer) {
    var paintProps = getLayerPaintType(layer.layer);
    paintProps.forEach(function(prop) {
        var options = {};
        if (layer.duration) {
            var transitionProp = prop + "-transition";
            options = { "duration": layer.duration };
            map.setPaintProperty(layer.layer, transitionProp, options);
        }
        map.setPaintProperty(layer.layer, prop, layer.opacity, options);
    });
}

var story = document.getElementById('story');
var features = document.createElement('div');
features.setAttribute('id', 'features');

config.chapters.forEach((record, idx) => {
    var container = document.createElement('div');
    var chapter = document.createElement('div');

    if (record.title) {
        var title = document.createElement('h3');
        title.innerText = record.title;
        chapter.appendChild(title);
    }

    if (record.image) {
        var image = new Image();
        image.src = record.image;
        chapter.appendChild(image);
    }

    if (record.description) {
        var story = document.createElement('p');
        story.innerHTML = record.description;
        chapter.appendChild(story);
    }

    container.setAttribute('id', record.id);
    container.classList.add('step');
    if (idx === 0) {
        container.classList.add('active');
    }

    chapter.classList.add(config.theme);
    container.appendChild(chapter);
    container.classList.add(alignments[record.alignment] || 'centered');
    if (record.hidden) {
        container.classList.add('hidden');
    }
    features.appendChild(container);
});

story.appendChild(features);

var footer = document.createElement('div');

if (config.footer) {
    var footerText = document.createElement('p');
    footerText.innerHTML = config.footer;
    footer.appendChild(footerText);
}

if (footer.innerText.length > 0) {
    footer.classList.add(config.theme);
    footer.setAttribute('id', 'footer');
    story.appendChild(footer);
}

mapboxgl.accessToken = config.accessToken;

const transformRequest = (url) => {
    const hasQuery = url.indexOf("?") !== -1;
    const suffix = hasQuery ? "&pluginName=scrollytellingV2" : "?pluginName=scrollytellingV2";
    return {
      url: url + suffix
    }
}

var map = new mapboxgl.Map({
    container: 'map',
    style: config.style,
    center: config.chapters[0].location.center,
    zoom: config.chapters[0].location.zoom,
    bearing: config.chapters[0].location.bearing,
    pitch: config.chapters[0].location.pitch,
    interactive: false,
    transformRequest: transformRequest,
    projection: config.projection
});

// Create a inset map if enabled in config.js
if (config.inset) {
 var insetMap = new mapboxgl.Map({
    container: 'mapInset', // container id
    style: 'mapbox://styles/madgallop/clpekqaqe006801p79o6x0yic', //hosted style id
    center: config.chapters[0].location.center,
    // Hardcode above center value if you want insetMap to be static.
    zoom: 5.5, // starting zoom
    hash: false,
    interactive: false,
    attributionControl: false
  });
}

// map.addSource('buildings_good_zoom_new-brvtke', {
//             type: "vector",
//             "url": "mapbox://madgallop.btzluc5i" // Your tileset URL
//         });


// instantiate the scrollama
var scroller = scrollama();

map.on("load", function() {
    const glowingTextBox = document.getElementById('glowingTextBox');


    let currentContent = ''; // Variable to store the current text content

    // Function to show the glowing text box
    function showGlowingTextBox(coordinates, currentChapterIndex) {
        if (glowingTextBox) {
            console.log("showing");

            // Set different text content based on the current chapter index
            switch (currentChapterIndex) {
                case 0:
                    currentContent = 'No one doubts that Jaffa is the greatest Arab city in Palestine, and it is inevitable that visitors to Palestine will stop by to see the model of Palestine’s cities.  The Arabs were the majority. The gateway to Palestine. The land of oranges - the oranges that, as according to a peasant who used to cultivate them until he left, would shrivel up if a change occurred. Every area of Palestine exported oranges branded Jaffa orange. The Arabs, both Muslim and Christian, planted oranges. I remember when we exported citrus, we’d watch them wrap oranges in paper and put them in boxes for export. They are real Jaffas, being gathered in the groves of Palestine. Mother of strangers. Bride of Palestine. the inhabitants of Jaffa in general believed -- like most of their fellow Palestinians throughout the land -- that the Palestinian was braver than the Jew and more capable of standing hardship. Surrounding Jaffa are the orange gardens for which it is justly extolled, and which are a considerable source of wealth.';
                    break;
                case 1:
                    currentContent = 'Jaffa is a special model for coexistence between Muslims, Jews, and Christians. The cultivation of the orange, introduced by the Arabs before the commencement of Jewish settlement, has developed to a very great extent in consequence of that settlement. We have deep connections and relations with Jewish people. A meeting place for all three, a special place. Jews and Arabs refused to be enemies. We worked together. A mixed city. Origin of orange cultivation. There is no doubt that the pitch of perfection to which the technique of plantation and cultivation of the orange and grapefruit have been brought in Palestine is due to the scientific methods of the Jewish agriculturist. Best Jaffa Oranges. The British built Faisel Street for carrying fruit Jaffa  Buy only totseret ha-arets! Citrus rush. The task of maintaining a fair balance between these elements and, at the same time, faithfully observing the spirit and letter of the Mandate is one of peculiar delicacy.  Jews and Arabs worked side by side.';
                    break;
                case 2:
                    currentContent = 'We were made to believe that the future of Israeli agriculture lays in our hands. One bad orange will not just spoil the whole crate, but imperil our reputation as the best orange growers in the world.  The servers came out carrying large baskets and handed every one of us an orange with a tiny green sticker that read “Jaffa.” As I put an orange segment in my mouth, I knew that I wasn’t just having my first taste of Israel, but was ingesting a Zionist symbol. The next day, on our El Al flight to Tel Aviv, female flight attendants wore bright orange skirts, orange striped tops, and funny orange colored hats. Someone explained to us that their unusual uniforms were an homage to Jaffa oranges. While the orange became the symbol of the Zionist enterprise and the state of Israel, for Palestinians it symbolizes the loss of their homeland and its destruction. A world destroyed. The break with the past must be absolute. Whoever could leave has left, there is fear everywhere, there is no safety.';
                    break;
                default:
                    currentContent = '';
                    glowingTextBox.style.opacity = '0';
                    break;
        }
            //     default:
            //         currentContent = 'Destruction text'; // Reset content to empty string
            //         break;               
            // }

            if (currentContent.trim() !== '') {
                glowingTextBox.textContent = currentContent;
                glowingTextBox.style.opacity = '1';
                glowingTextBox.style.pointerEvents = 'auto';
            } else {
                console.error('Invalid chapter index or no content found!');
            }
        } else {
            console.error('Glowing text box element not found!');
        }
    }


    // Function to hide the glowing text box
    function hideGlowingTextBox() {
        if (glowingTextBox) {
            console.log("hiding");
            glowingTextBox.style.opacity = '0'; // Reduce opacity to hide the box
            glowingTextBox.style.pointerEvents = 'none'; // Disable interactions when hidden
        }
    }

    function getCurrentChapterIndex() {
        const activeChapterElement = document.querySelector('.step.active');
        const currentChapterIndex = Array.from(activeChapterElement.parentNode.children).indexOf(activeChapterElement);
        return currentChapterIndex;
    }

    map.on('click', 'jafffa-orange-groves', (e) => {
        const currentChapterIndex = getCurrentChapterIndex(); // Get the current chapter index
        showGlowingTextBox(e.lngLat, currentChapterIndex);
    });

    map.on('click', (e) => {
        const isInsideOrangeGrovesLayer = map.queryRenderedFeatures(e.point, { layers: ['jafffa-orange-groves'] }).length > 0;
        if (!isInsideOrangeGrovesLayer) {
            hideGlowingTextBox();
        }
    });

    // document.addEventListener('click', (e) => {
    //     hideGlowingTextBox();
    // });

    insetMap.on("load", function() {
        var insetCanvas = document.getElementById('insetCanvas')
        var insetContext = insetCanvas.getContext('2d');
        if (insetContext) {
            insetContext.willReadFrequently = true;
        }

        var insetMapCanvas = insetMap.getCanvas();
        insetCanvas.width = insetMapCanvas.width;
        insetCanvas.height = insetMapCanvas.height;

        // Capture the inset map onto the canvas
        insetContext.drawImage(insetMap.getCanvas(), 0, 0)
    });

    // setup the instance, pass callback functions
    scroller
    .setup({
        step: '.step',
        offset: 0.5,
        progress: true
    })
    
    .onStepEnter(async response => {
        var chapterRadii = [1.8, 4.5, 2.625, 0]
        var center = turf.point([34.71250, 32.0686]);
        var options = {
        steps: 80,
        units: 'kilometers'
        };
        var circle = turf.circle(center, chapterRadii[0], options);

        var current_chapter = config.chapters.findIndex(chap => chap.id === response.element.id);
        var chapter = config.chapters[current_chapter];
        var newRadius = chapterRadii[current_chapter];

        document.querySelectorAll('.timeline-marker').forEach(marker => {
            marker.classList.remove('active-timeline-marker');
        });

        // Add active class to the corresponding timeline marker
        var currentTimelineMarker = document.querySelector(`.timeline-marker[data-chapter="${current_chapter}"]`);
        if (currentTimelineMarker) {
            currentTimelineMarker.classList.add('active-timeline-marker');
        }

        // document.getElementById("exposition").classList.add("exposition-hidden");

        var circleFillLayer = map.getLayer("circle-fill");
        var circleOutlineLayer = map.getLayer("circle-outline");
        var chapterOutlines = {}; // Object to store chapter outlines

        function updateCircleRadiusAndStoreOutline(radius, response) {
            var center = turf.point([34.71060, 32.0686]);
            var options = {
                steps: 80,
                units: 'kilometers'
            };
            var newCircle = turf.circle(center, radius, options);

            if (map.getLayer('circle-fill')) {
                map.removeLayer('circle-fill');
                map.removeSource('circle-fill');
            }

            map.addLayer({
                "id": "circle-fill",
                "type": "fill",
                "source": {
                    "type": "geojson",
                    "data": newCircle
                },
                "paint": {
                    "fill-pattern": "newestOrangeBabe-01",
                    "fill-opacity": 1
                }
            });

            map.getSource("circle-fill").setData(newCircle);

            // Store the outline based on chapter ID
            chapterOutlines[response.element.id] = newCircle;

            // Loop through stored outlines to manage display and removal
            Object.keys(chapterOutlines).forEach((chapterId, index) => {
                var outline = chapterOutlines[chapterId];
                var isActiveChapter = chapterId === response.element.id;
                
                var lineOpacity = isActiveChapter ? 1 : 0.3;
                var lineDashArray = isActiveChapter ? undefined : [5, 3];

                var layerId = 'circle-outline-' + index;
                var existingLayer = map.getLayer(layerId);

                if (existingLayer) {
                    map.removeLayer(layerId);
                    map.removeSource(layerId);
                }

                var paintProperties = {
                    'line-color': '#9DA47F',
                    'line-opacity': lineOpacity,
                    'line-width': isActiveChapter ? 3 : 3 * 0.5
                };

                if (lineDashArray) {
                    paintProperties['line-dasharray'] = lineDashArray;
                }

                map.addLayer({
                    'id': layerId,
                    'type': 'line',
                    'source': {
                        'type': 'geojson',
                        'data': outline
                    },
                    'paint': paintProperties
                });
                
                // Remove inactive chapter outlines from the stored object and the map
                if (!isActiveChapter) {
                    delete chapterOutlines[chapterId];
                }
            });
        }


        const responseObj = {
            element: {
                id: response.element.id // Assuming this is where 'id' is stored
                // Other properties if needed
            }
        };

        updateCircleRadiusAndStoreOutline(newRadius, responseObj);


        response.element.classList.add('active');
        map[chapter.mapAnimation || 'flyTo'](chapter.location);

        // Update the circle radius based on the chapter


        // if (config.chapters[index].id === 'fourth-chapter') {
        //     // Add the building footprints layer
        //     map.addLayer({
        //         "id": "jaffa-building-footprints",
        //         "type": "fill", // Assuming it's a fill layer
        //         "source": 'buildings_good_zoom_new-brvtke',
        //         "source-layer": " jaffa_building_footprints", // Specify your source layer name
        //         "paint": {
        //             "fill-color": "#000000",
        //             "fill-opacity": 1 // Adjust opacity as needed
        //             // Add other paint properties
        //         }
        //     });
        // }
        
        if (chapter.onChapterEnter.length > 0) {
            chapter.onChapterEnter.forEach(setLayerOpacity);
        }
        if (chapter.callback) {
            window[chapter.callback]();
        }
        if (config.auto) {
             var next_chapter = (current_chapter + 1) % config.chapters.length;
             map.once('moveend', () => {
                 document.querySelectorAll('[data-scrollama-index="' + next_chapter.toString() + '"]')[0].scrollIntoView();
             });
        }
    })
    
    .onStepExit(response => {
        // if (response.element.id === 'fourth-chapter') {
        //     // Remove the building footprints layer
        //     map.removeLayer('jaffa-building-footprints');
        // }
        var chapter = config.chapters.find(chap => chap.id === response.element.id);
        response.element.classList.remove('active');
        if (chapter.onChapterExit.length > 0) {
            chapter.onChapterExit.forEach(setLayerOpacity);
        }
    });

    if (config.auto) {
        document.querySelectorAll('[data-scrollama-index="0"]')[0].scrollIntoView();
    }
});

window.addEventListener('scroll', function() {
    var scrollTop = window.scrollY;
    var exposition = document.getElementById('exposition');
    var mapContainer = document.getElementById('map-container');

    if (scrollTop > exposition.offsetHeight) {
        exposition.classList.add('exposition-hidden');
        var mapTop = Math.max(0, exposition.offsetHeight - scrollTop);
        var mapHeight = Math.max(0, 100 - (scrollTop / window.innerHeight) * 100);
        mapContainer.style.top = mapTop + 'px';
        mapContainer.style.height = 'calc(' + mapHeight + 'vh)';
        mapContainer.style.position = 'fixed';
    } else {
        exposition.classList.remove('exposition-hidden');
        mapContainer.style.top = 0;
        mapContainer.style.height = '100vh';
        mapContainer.style.position = 'relative'; // Reset position to default
    }
});

const mapElement = document.getElementById('map');



document.addEventListener("DOMContentLoaded", function () {
    const markers = document.querySelectorAll(".timeline-marker");

    // Add click event listeners to timeline markers
    markers.forEach((marker, index) => {
        marker.addEventListener("click", () => {
            // Scroll to the corresponding chapter
            scrollToChapter(index);
        });
    });

    // Function to scroll to the corresponding chapter
    function scrollToChapter(step) {
        const chapters = document.querySelectorAll(".step");
        if (chapters[step]) {
            chapters[step].scrollIntoView({ behavior: "smooth" });
        }
    }
});

</script>
</body>
</html>