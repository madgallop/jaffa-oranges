<!DOCTYPE html>
<html> 
<head>
    <meta charset='utf-8' />
    <title>Mapbox Storytelling</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/mapbox/assembly/publisher-staging/src/svgs/mapbox.svg">
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@600;800&display=swap" rel="stylesheet">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/intersection-observer@0.12.0/intersection-observer.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://unpkg.com/scrollama"></script>
    <style>
        /* Add a new class to control visibility of the exposition */
        .exposition-hidden {
            display: none;
        }
        /* Sticky positioning for the exposition */
        #exposition {
            background-image: url('https://github.com/madgallop/jaffa-oranges/blob/main/docs/images/landing_place.jpg?raw=true');
            background-size: 60% auto; /* Makes the background image slightly smaller */
            background-origin: content-box; /* Preserves the background color within padding */
            background-clip: content-box; /* Applies the background within the padding */
            background-position: center;
            background-color: #f6f3eeb7; 
            background-repeat: no-repeat; /* Prevents the background image from repeating */
            background-attachment: fixed; /* Fixes the background position */
            text-align: center; /* Center the text */
            font-family: 'EB Garamond', serif; /* Use EB Garamond font */
            box-sizing: border-box;
            height: 96vh; /* Set the height to half the viewport height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 1000;
        }
        #map-container {
            position: flex;
            width: 100%;
            top: 0; 
            height: 100vh; /* Occupy the remaining viewport height */
            transition: height 0.3s ease; /* Add transition for smooth height change */
        }
        body {
            margin:0;
            padding:0;
            font-family: 'Avenir', sans-serif;
            font-weight: normal;
            opacity: 1;
            color: #4d4d4dec;
            text-align: justify;
        }
        #map {
            height: 100vh;
            width: 100%;
            position: absolute; /* Change to relative for proper placement */
            z-index: 0;
        }
        /* Adjustments for the exposition text */

        /* Font for title and subtitle */
        .h1-text{
            color: rgb(119, 118, 118);
            position: absolute;
            top: 0;
            left: 20.5%;
            padding: 2vh 1vw; /* Adjust the padding as needed */
            font-size: 22px; /* Adjust the font size as needed */
            text-align: center;
            font-weight: bold;
            font-family: 'EB+Garamond', serif;
            letter-spacing: 5px;
        }
        .p1-text{
            color: rgb(119, 118, 118);
            max-width: 30vh;
            position: absolute;
            top: 16vh;
            left: 5vh;
            padding: 8vh 7vw; /* Adjust the padding as needed */
            max-width: 50vh; /* Set the maximum width to 50% */
            margin: 0 auto; /* Center the element horizontally */
            font-size: 18px; /* Adjust the font size as needed */
            text-align: center;
            float:left;
            font-family: 'EB+Garamond', serif; /* Use correct font name */
            letter-spacing: 1px; 
            background-color: #dddbc8e0;
        }
        .p3-text {
            margin: 0;
            position:absolute;
            top:40vh;
            right: 7vh;
            color: rgb(119, 118, 118);
            max-width: 30vh;
            padding: 5vh 8vw;
            font-size: 17px; /* Adjust the font size as needed */
            text-align: center;
            float: right;
            font-family: 'EB+Garamond', serif;
            font-weight: lighter;
            background-color:#e7c094d7;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from {
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.9), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.9);
            }
        }
        /* Font for chapters */
        .step h3 {
            font-family: 'Avenir', sans-serif;
            font-weight: bold;
            color: rgb(136, 136, 136);
            margin: 0;
            padding: 0.5vh 0.2vw; /* Adjust the padding as needed */
            text-align: left;
            font-size: 15px;
            width: 50%; /* Set the width to 50% */
            text-align: left;
            letter-spacing: 0px; 
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        /* Active class for fade-in */
        .step.active h3 {
            transition: opacity 1s ease;
            opacity: 1;
        }
        .step p {
            font-family: 'Avenir', sans-serif;
            font-weight: normal;
            color: rgb(136, 136, 136);
            margin: 0;
            padding: 0.5vh 0.2vw; /* Adjust the padding as needed */
            text-align: left;
            font-size: 13px;
            width: 50%; /* Set the width to 50% */
            text-align: left;
            letter-spacing: 0px; 
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        /* Active class for fade-in */
        .step.active p {
            transition: opacity 1s ease;
            opacity: 1;
        }
        #timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100vw;
            margin: 60px 5px;
            position: fixed;
            bottom: 0;
            z-index: 2;
        }
        .timeline-marker {
            background: #EFBF8F;
            width: 20px;
            margin: 10px 25px;
            height: 20px;
            border-radius: 50vw;
            cursor: pointer;
            text-align: center;
            font-size: 15px;
            font-family: 'EB+Garamond', serif;
            color: rgb(119, 118, 118);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 2;
        }
        .timeline-marker:hover {
            background: #f6a14c;
        }
        /* Example CSS to highlight the active timeline marker */
        .timeline-marker.active-timeline-marker {
            background-color: #f6a14c; /* Change the color as desired */
            /* Add any other styles to visually highlight the active marker */
        }
        .text-container {
            background-color: rgba(238, 237, 237, 0); /* Background color for the text */
            padding: 10px; /* Adjust the padding as needed */
            border-radius: 0; /* Adjust border radius as needed */
            z-index: -1;
        }
        .timeline-line {
            position: fixed;
            background-color: #EFBF8F;
            height: 3px; /* Adjust the height of the line as needed */
            width: calc(100% - 75px); /* Width of the line is the container width minus marker margins */
            transform: translateY(-1px); /* Center the line vertically */
            left: 20px;
            right:10px;
            margin: 10px 25px;
            z-index: 0; /* Place the line behind markers */
        }
        .timeline-marker:nth-child(1) {
            left: 0%;
        }

        .timeline-marker:nth-child(2) {
            left: 40%;
        }

        .timeline-marker:nth-child(3) {
            left: 65%;
        }

        .timeline-marker:nth-child(4) {
            left: 100%;
        }
        
        #scale-bar {
            position: fixed;
            bottom: 0;            
            margin: 3px 140px;
            background: rgba(255, 255, 255, 0);
            border: 2px solid #EFBF8F;
            padding: 5px 27px;
            font-size: 12px;
            font-family: 'EB+Garamond', serif;
            color: rgb(119, 118, 118);
        }
        #mapInset {
            bottom:50px;
            right:30px;
            height: 80px; /* Example height */
            width: 120px; /* Example width */
            max-width:100%;
            position: fixed;
            z-index: 1;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            display: none;
        }

        /* #mapInset .mapboxgl-ctrl-bottom-left{
            display: none;
        }
        @media (max-width: 500px) {
            #mapInset {
                display: none;
            }
        } */
        #footer {
            width: 100%;
            min-height: 5vh;
            padding-top: 2vh;
            padding-bottom: 2vh;
            text-align: center;
            line-height: 25px;
            font-size: 13px;
            position: relative;
            z-index: 5;
        }
        #glowingTextBox {
            position: fixed;
            max-width: 13%;
            top: 150px; /* Adjust the top position */
            right: 1vw; /* Adjust the position based on screen width */
            z-index: 9999;
            padding: 10px;
            background-color: rgba(246, 243, 238, 0.761);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            pointer-events: none;
            text-align: center;
            font-size: 14px;
            font-family: 'Avenir', sans-serif;
            font-weight: 50;
            color: rgb(119, 118, 118);
            /* Other styles */
        }
        .glow-visible {
            opacity: 1; /* Make the box visible when this class is added */
            pointer-events: auto; /* Enable interactions when visible */
        }
        .glow-hidden {
            opacity: 0; /* Make the box visible when this class is added */
            pointer-events: none; /* Enable interactions when visible */
        }
        #features {
            padding-top: 10vh;
            padding-bottom: 10vh;
        }
        .hidden {
            visibility: hidden;
        }
        .centered {
            width: 50vw;
            margin: 0 auto;
        }
        .lefty {
            width: 33vw;
            margin-left: 2vw;
        }
        .righty {
            width: 33vw;
            margin-left: 62vw;
        }
        .fully {
            width: 100%;
            margin: auto;
        }
        .light {
            color: #444;
            background-color: #fafafa00;
        }
        .dark {
            color: #fafafa;
            background-color: #444;
        }
        .step {
            padding-bottom: 50vh;
            /* margin-bottom: 10vh; */
            opacity: 0;
            transition: opacity 1s ease; /* Add transition effect over 2 seconds */
        }
        .step.active {
            transition: opacity 1s ease-in-out;
            opacity: 0.9;
        }

        .step div {
            padding:  25px 0px;
            line-height: 25px;
            font-size: 15px;
        }

        .step img {
            width: 100%;
        }
        .mapboxgl-popup-content {
            font: 400 15px/22px 'Source Sans Pro', 'Helvetica Neue', sans-serif;
            padding: 0;
            width: 180px;
            /* Set the background color and opacity for the popup */
            background-color: rgba(246, 243, 238, 0.908);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .mapboxgl-popup-content h4 {
            margin: 0;
            padding: 10px;
            font-weight: 400;
            /* Adjust text color if needed */
            color: #333;
        }

        .mapboxgl-popup-content div {
        padding: 10px;
        }

        .mapboxgl-popup-anchor-top > .mapboxgl-popup-content {
        margin-top: 15px;
        }

        .mapboxgl-popup-anchor-top > .mapboxgl-popup-tip {
            display: none
        }
        .mapboxgl-popup-tip {
            display: none; /* Hide the tip */
        }

        @media (max-width: 750px) {
            .centered, .lefty, .righty, .fully {
                display: none;
                width: 90vw;
                margin: 0 auto;
            }
        }

        /* Fix issue on mobile browser where scroll breaks  */
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan .mapboxgl-canvas {
            touch-action: unset;
        }

        </style>
</head>
<body>

<div id="exposition" class="exposition-hidden">
    <div class="title-text">
        <h1 class="h1-text">THE PERFECT BITE:<br> COLLABORATION AND DISPOSSESSION IN JAFFA, PALESTINE</h1>
        <p class="p1-text">The Jaffa orange is a powerful and contested symbol of identity. Originating in Jaffa, historically known as the 'gateway to Palestine,' the Shamouti orange emerged from the labor and innovation of Palestinian farmers during the mid-19th century. This unusually thick and nearly seedless fruit became synonymous with Jaffa's production and export. Its narrative mirrors the tumultuous history of the land itself. The story of Jaffa's dispossession—of industry, land, and of identity—resonates with the plight of dozens of Palestinian towns. Once a symbol of Palestinian prowess and pride in cultivation, the orange now embodies loss and estrangement. <br><br>The map below explores the story of cultivation, collaboration, and loss in Palestine through focusing on the Jaffa orange industry, from its inception to its eventual decline in the late 20th century.</p>
        <p class="p3-text">Scroll to view the story or click one of the defining periods on the timeline below.</p>
    </div>
</div>
<div id="glowingTextBox" class="glow-hidden">
    <span class="close-button">&times;</span>
</div>
<div id="map-container">
    <div id="map"></div>
</div>
<div id="scale-bar" class="mapboxgl-ctrl mapboxgl-ctrl-scale">
    <span>1km</span>
</div>
<div id="timeline">
    <div class="timeline-marker" data-chapter="1">
        <div class="text-container">
            <p id="chapter-1-text">Palestinian Period</p>
        </div>
    </div>
    <div class="timeline-marker" data-chapter="2">
        <div class="text-container">
            <p id="chapter-1-text">Collaborative Period</p>
        </div>
    </div>
    <div class="timeline-marker" data-chapter="3">
        <div class="text-container">
            <p id="chapter-1-text">Israeli Period</p>
        </div>
    </div>
    <div class="timeline-marker" data-chapter="4">
        <div class="text-container">
            <p id="chapter-1-text">Decline</p>
        </div>
    </div>
    <div class="timeline-line"></div>
</div>
<div id="mapInset"></div>
<div id="story"></div>
  

<script src="./config.js"></script>
<script>
var initLoad = true;
var layerTypes = {
    'fill': ['fill-opacity'],
    'line': ['line-opacity'],
    'circle': ['circle-opacity', 'circle-stroke-opacity'],
    'symbol': ['icon-opacity', 'text-opacity'],
    'raster': ['raster-opacity'],
    'fill-extrusion': ['fill-extrusion-opacity'],
    'heatmap': ['heatmap-opacity']
}

var alignments = {
    'left': 'lefty',
    'center': 'centered',
    'right': 'righty',
    'full': 'fully'
}

function getLayerPaintType(layer) {
    var layerType = map.getLayer(layer).type;
    return layerTypes[layerType];
}

function setLayerOpacity(layer) {
    var paintProps = getLayerPaintType(layer.layer);
    paintProps.forEach(function(prop) {
        var options = {};
        if (layer.duration) {
            var transitionProp = prop + "-transition";
            options = { "duration": layer.duration };
            map.setPaintProperty(layer.layer, transitionProp, options);
        }
        map.setPaintProperty(layer.layer, prop, layer.opacity, options);
    });
}

var story = document.getElementById('story');
var features = document.createElement('div');
features.setAttribute('id', 'features');

config.chapters.forEach((record, idx) => {
    var container = document.createElement('div');
    var chapter = document.createElement('div');

    if (record.title) {
        var title = document.createElement('h3');
        title.innerText = record.title;
        chapter.appendChild(title);
    }

    if (record.image) {
        var image = new Image();
        image.src = record.image;
        chapter.appendChild(image);
    }

    if (record.description) {
        var story = document.createElement('p');
        story.innerHTML = record.description;
        chapter.appendChild(story);
    }

    container.setAttribute('id', record.id);
    container.classList.add('step');
    if (idx === 0) {
        container.classList.add('active');
    }

    chapter.classList.add(config.theme);
    container.appendChild(chapter);
    container.classList.add(alignments[record.alignment] || 'centered');
    if (record.hidden) {
        container.classList.add('hidden');
    }
    features.appendChild(container);
    
    if (idx >= 1 && idx !== 4){
        const chapterButtonDiv = document.createElement('div');
        const chapterButton = document.createElement('button');
        chapterButton.innerText = `Show Chapter ${idx} Places`;
        chapterButton.classList.add('chapter-button');

        chapterButtonDiv.appendChild(chapterButton);
        container.appendChild(chapterButtonDiv);

        // Add event listener to each chapter button
        chapterButton.addEventListener('click', () => {
            displayMarkersForChapter(record.id);
    });
    }
    
});

story.appendChild(features);

var footer = document.createElement('div');

if (config.footer) {
    var footerText = document.createElement('p');
    footerText.innerHTML = config.footer;
    footer.appendChild(footerText);
}

if (footer.innerText.length > 0) {
    footer.classList.add(config.theme);
    footer.setAttribute('id', 'footer');
    story.appendChild(footer);
}

mapboxgl.accessToken = config.accessToken;

const transformRequest = (url) => {
    const hasQuery = url.indexOf("?") !== -1;
    const suffix = hasQuery ? "&pluginName=scrollytellingV2" : "?pluginName=scrollytellingV2";
    return {
      url: url + suffix
    }
}

var map = new mapboxgl.Map({
    container: 'map',
    style: config.style,
    center: config.chapters[0].location.center,
    zoom: config.chapters[0].location.zoom,
    bearing: config.chapters[0].location.bearing,
    pitch: config.chapters[0].location.pitch,
    interactive: false,
    transformRequest: transformRequest,
    projection: config.projection
});


// instantiate the scrollama
var scroller = scrollama();

function displayMarkersForChapter(currentChapter) {
    const placesData = map.getSource('places')._data;

    // Remove existing popups
    const popUps = document.getElementsByClassName('mapboxgl-popup');
    while (popUps[0]) {
        popUps[0].remove();
    }

    // Logic to show popups based on the currentChapter
    if (currentChapter === "slug-style-id") {
        const firstThreePlaces = placesData.features.filter(place => place.id === 1 || place.id === 2 || place.id === 3 || place.id === 4 || place.id === 5 || place.id === 6);
        firstThreePlaces.forEach(place => {
            createPopUp(place);
        });
    } else if (currentChapter === "second-identifier") {
        const lastThreePlaces = placesData.features.filter(place => place.id === 7 || place.id === 8|| place.id === 9|| place.id === 10|| place.id === 11|| place.id === 12|| place.id === 19|| place.id === 20);
        lastThreePlaces.forEach(place => {
            createPopUp(place);
        });
    } 
    else if (currentChapter === "third-identifier") {
        const lastThreePlaces = placesData.features.filter(place => place.id === 13 || place.id === 14 || place.id === 15|| place.id === 16|| place.id === 17|| place.id === 18);
        lastThreePlaces.forEach(place => {
            createPopUp(place);
        });
    } else {
        // Handle other chapters if needed
    }
}

// Function to create popup for each feature
function createPopUp(currentFeature) {
    const popup = new mapboxgl.Popup({ closeOnClick: true })
        .setLngLat(currentFeature.geometry.coordinates)
        .setHTML(`<h4>${currentFeature.properties.description}</h4>`)
        .addTo(map);
}

map.on("load", function() {
    map.addSource('places', {
        // This GeoJSON contains features that include an "icon"
        // property. The value of the "icon" property corresponds
        // to an image in the Mapbox Streets style's sprite.
        'type': 'geojson',
        'data': {
        'type': 'FeatureCollection',
        'features': [
        {
        'type': 'Feature',
        'id':1,
        'properties': {
        'description':
        '<p>Ismail Abou Shahadeh, Palestinian orchard mechanic</p><iframe src="https://youtube.com/embed/mo6ENwASPFE" frameborder="0" style="width: 100%; max-width: 200px;"></iframe>,'
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.783, 32.034]
        }
        },
        {
        'type': 'Feature',
        'id':2,
        'properties': {
        'description':
        '<p>Family orange packing workshop, 1907</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/familyPacking1907.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.680, 32.053]
        }
        },
        {
        'type': 'Feature',
        'id':3,
        'properties': {
        'description':
        '<p>Jaffa from the groves</p><iframe src="https://youtube.com/embed/z8J0aKvwGDs" frameborder="0" style="width: 100%; max-width: 200px;"></iframe>,'
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.758, 32.065]
        }
        },
        {
        'type': 'Feature',
        'id':4,
        'properties': {
        'description':
        '<p>Jewish and Arab Palestinian orange pickers in 1915</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/1915Image.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.734, 32.037]
        }
        },
        {
        'type': 'Feature',
        'id':5,
        'properties': {
        'description':
        '<p>Early Dutch export comapany in Yaffa</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/earlyExports.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.816, 32.075]
        }
        },
        {
        'type': 'Feature',
        'id':6,
        'properties': {
        'description':
        '<p>Orange export boats in the late 19th century</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/jaffaBoats.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.708, 32.065]
        }
        },




        {
        'type': 'Feature',
        'id':7,
        'properties': {
        'description':
        '<p>Jaffa orange advertisement c. 1930s</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/30sAdd.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.783, 32.034]
        }
        },
        {
        'type': 'Feature',
        'id': 8,
        'properties': {
            'description': `
                <p>1928 lithographs</p>
                <img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/aPerfectBite.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">
                <img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/LordOfOranges.jpg" alt="Another Image" style="width: 100%; max-width: 200px;">
            `,
            // 'icon': "none",
        },
        'geometry': {
            'type': 'Point',
            'coordinates': [34.680, 32.053]
        }
        },
        {
        'type': 'Feature',
        'id':9,
        'properties': {
        'description':
        '<p>Jaffa orange fields before the Nakba</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/1948PreNakbaGroves.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.758, 32.065]
        }
        },
        {
        'type': 'Feature',
        'id':10,
        'properties': {
        'description':
        '<p>Promotional ad for Jaffa oranges and juice, 1947</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/1947CollabAdvertisement.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.734, 32.037]
        }
        },
        {
        'type': 'Feature',
        'id':11,
        'properties': {
        'description':
        '<p>1927 award from the Palestine Zionist Comission</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/Prize1927.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.826, 32.075]
        }
        },
        {
        'type': 'Feature',
        'id':12,
        'properties': {
        'description':
        '<p>Announcement about orange box availability in 1947 edition of "Palestine."</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/1947NewspaperArabicCollab.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.708, 32.1]
        }
        },
        {
        'type': 'Feature',
        'id':19,
        'properties': {
        'description':
        '<p>Television report on coexistance in the industry</p><iframe src="https://youtube.com/embed/vSwCPbxHRYE" frameborder="0" style="width: 100%; max-width: 200px;"></iframe>,'
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.76, 32.030]
        }
        },
        {
        'type': 'Feature',
        'id':20,
        'properties': {
        'description':
        '<p>Advertisement, circa 1930</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/realCollabCirca1930.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.670, 32.023]
        }
        },
        



        {
        'type': 'Feature',
        'id':13,
        'properties': {
        'description':
        '<p>Israeli advertisement</p><iframe src="https://youtube.com/embed/CY3uly23LPU" frameborder="0" style="width: 100%; max-width: 200px;"></iframe>,'
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.793, 32.034]
        }
        },
        {
        'type': 'Feature',
        'id':14,
        'properties': {
        'description':
        '<p>Ilan Gur: <i>“We were made to believe that the future of Israeli agriculture lays in our hands. One bad orange will not just spoil the whole crate, but imperil our reputation as the best orange growers in the world.”</i></p>',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.680, 32.053]
        }
        },
        {
        'type': 'Feature',
        'id':15,
        'properties': {
        'description':
        '<p>Citrus is the splendor of our country and its wealth</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/splendor.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.758, 32.065]
        }
        },
        {
        'type': 'Feature',
        'id':16,
        'properties': {
        'description':
        '<p>Israeli citrus exhibition</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/IsrealExhibition.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.734, 32.037]
        }
        },
        {
        'type': 'Feature',
        'id':17,
        'properties': {
        'description':
        '<p>Israeli flight attendance dressed in Orange</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/flightAttend.jpg" alt="Image Description"style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.816, 32.075]
        }
        },
        {
        'type': 'Feature',
        'id':18,
        'properties': {
        'description':
        '<p>Israeli stamp, 1958</p><img src="/Users/madeleinegallop/Documents/fall2023/Cartography/jaffa-oranges/docs/images/orangeStamp.jpg" alt="Image Description" style="width: 100%; max-width: 200px;">',
        // 'icon': "none",
        },
        'geometry': {
        'type': 'Point',
        'coordinates': [34.708, 32.081]
        }
        },

        ]
        }
    });
    // Add a layer showing the places.
    map.addLayer({
        'id': 'places',
        'type': 'symbol',
        'source': 'places',
        'layout': {
        'icon-image': ['get', 'icon'],
        'icon-size': 1,
        'icon-allow-overlap': true,
    }
    });

        // Change the cursor to a pointer when the mouse is over the places layer.
    map.on('mouseenter', 'places', () => {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'places', () => {
        map.getCanvas().style.cursor = '';
    });

    const glowingTextBox = document.getElementById('glowingTextBox');

    let currentContent = ''; // Variable to store the current text content

    // Function to show the glowing text box
    function showGlowingTextBox(coordinates, currentChapterIndex) {
        if (glowingTextBox) {
            // console.log("showing");

            // Set different text content based on the current chapter index
            switch (currentChapterIndex) {
                case 1:
                    currentContent = 'No one doubts that Jaffa is the greatest Arab city in Palestine, and it is inevitable that visitors to Palestine will stop by to see the model of Palestine’s cities.  The Arabs were the majority. The gateway to Palestine. The land of oranges - the oranges that, as according to a peasant who used to cultivate them until he left, would shrivel up if a change occurred. Every area of Palestine exported oranges branded Jaffa orange. The Arabs, both Muslim and Christian, planted oranges. I remember when we exported citrus, we’d watch them wrap oranges in paper and put them in boxes for export. They are real Jaffas, being gathered in the groves of Palestine. Mother of strangers. Bride of Palestine. the inhabitants of Jaffa in general believed -- like most of their fellow Palestinians throughout the land -- that the Palestinian was braver than the Jew and more capable of standing hardship. Surrounding Jaffa are the orange gardens for which it is justly extolled, and which are a considerable source of wealth.';
                    break;
                case 2:
                    currentContent = 'Jaffa is a special model for coexistence between Muslims, Jews, and Christians. The cultivation of the orange, introduced by the Arabs before the commencement of Jewish settlement, has developed to a very great extent in consequence of that settlement. We have deep connections and relations with Jewish people. A meeting place for all three, a special place. Jews and Arabs refused to be enemies. We worked together. A mixed city. Origin of orange cultivation. There is no doubt that the pitch of perfection to which the technique of plantation and cultivation of the orange and grapefruit have been brought in Palestine is due to the scientific methods of the Jewish agriculturist. Best Jaffa Oranges. The British built Faisel Street for carrying fruit Jaffa  Buy only totseret ha-arets! Citrus rush. The task of maintaining a fair balance between these elements and, at the same time, faithfully observing the spirit and letter of the Mandate is one of peculiar delicacy.  Jews and Arabs worked side by side.';
                    break;
                case 3:
                    currentContent = 'We were made to believe that the future of Israeli agriculture lays in our hands. One bad orange will not just spoil the whole crate, but imperil our reputation as the best orange growers in the world.  The servers came out carrying large baskets and handed every one of us an orange with a tiny green sticker that read “Jaffa.” As I put an orange segment in my mouth, I knew that I wasn’t just having my first taste of Israel, but was ingesting a Zionist symbol. The next day, on our El Al flight to Tel Aviv, female flight attendants wore bright orange skirts, orange striped tops, and funny orange colored hats. Someone explained to us that their unusual uniforms were an homage to Jaffa oranges. While the orange became the symbol of the Zionist enterprise and the state of Israel, for Palestinians it symbolizes the loss of their homeland and its destruction. A world destroyed. The break with the past must be absolute. Whoever could leave has left, there is fear everywhere, there is no safety.';
                    break;
                default:
                    currentContent = '';
                    glowingTextBox.style.opacity = '0';
                    break;
        }
            //     default:
            //         currentContent = 'Destruction text'; // Reset content to empty string
            //         break;               
            // }

            if (currentContent.trim() !== '') {
                glowingTextBox.textContent = currentContent;
                glowingTextBox.style.opacity = '1';
                glowingTextBox.style.pointerEvents = 'auto';
            } else {
                console.error('Invalid chapter index or no content found!');
            }
        } else {
            console.error('Glowing text box element not found!');
        }
    }

    const closeButton = document.getElementById('closeButton');

    if (closeButton) {
        closeButton.addEventListener('click', hideGlowingTextBox);
    }


    // Function to hide the glowing text box
    function hideGlowingTextBox() {
        if (glowingTextBox) {
            // console.log("hiding");
            glowingTextBox.style.opacity = '0'; // Reduce opacity to hide the box
            glowingTextBox.style.pointerEvents = 'none'; // Disable interactions when hidden
        }
    }

    function getCurrentChapterIndex() {
        const activeChapterElement = document.querySelector('.step.active');
        const currentChapterIndex = Array.from(activeChapterElement.parentNode.children).indexOf(activeChapterElement);
        return currentChapterIndex;
    }

    map.on('click', 'jafffa-orange-groves', (e) => {
        const currentChapterIndex = getCurrentChapterIndex(); // Get the current chapter index
        showGlowingTextBox(e.lngLat, currentChapterIndex);
    });

    map.on('click', (e) => {
        const isInsideOrangeGrovesLayer = map.queryRenderedFeatures(e.point, { layers: ['jafffa-orange-groves'] }).length > 0;
        if (!isInsideOrangeGrovesLayer) {
            hideGlowingTextBox();
        }
    });


    // Add text labels along the curve as a SymbolLayer
    


    // setup the instance, pass callback functions
    circleOutlines = []

    scroller
    .setup({
        step: '.step',
        offset: 0.5,
        progress: true
    })
    
    .onStepEnter(async response => {
        var chapterRadii = [0, 1.8, 4.5, 2.625, 0]
        var center = turf.point([34.71250, 32.0686]);
        var options = {
        steps: 80,
        units: 'kilometers'
        };
        var circle = turf.circle(center, chapterRadii[0], options);

        var current_chapter = config.chapters.findIndex(chap => chap.id === response.element.id);
        // console.log(current_chapter)
        // console.log(response.element.id)
        var chapter = config.chapters[current_chapter];
        var newRadius = chapterRadii[current_chapter];

        document.querySelectorAll('.timeline-marker').forEach(marker => {
            marker.classList.remove('active-timeline-marker');
        });

        // Add active class to the corresponding timeline marker
        var currentTimelineMarker = document.querySelector(`.timeline-marker[data-chapter="${current_chapter}"]`);
        if (currentTimelineMarker) {
            currentTimelineMarker.classList.add('active-timeline-marker');
        }

        // document.getElementById("exposition").classList.add("exposition-hidden");

        // if (map.getLayer('curved-path-labels')) {
        //     map.removeLayer('curved-path-labels');
        //     map.removeSource('curved-path-labels');
        // }
        // if (map.getLayer('Palestine-label')) {
        //     map.removeLayer('curved-path-labels');
        //     map.removeSource('curved-path-labels');
        // }
        // if (map.getLayer('Israeli-label')) {
        //     map.removeLayer('curved-path-labels');
        //     map.removeSource('curved-path-labels');
        // }

        map.addLayer({
            id: 'curved-path-labels',
            type: 'symbol',
            source: {
                type: 'geojson',
                data: {
                    "type": "Feature",
                    "properties": {
                    "type": "Circle size ~ boxes exported per acre of groves",
                    },
                    "geometry": {
                        "coordinates": [
                            [
                                34.69282439564928,
                                32.026081158669825
                            ],
                            [
                                34.69765339564928,
                                32.02499915866983
                            ],
                            [
                                34.703312395649284,
                                32.024218158669825
                            ],
                            [
                                34.70887739564928,
                                32.02375215866983
                            ],
                            [
                                34.71296339564928,
                                32.02377015866983
                            ],
                            [
                                34.71682486613967,
                                32.02396610036278
                            ],
                            [
                                34.72140686613967,
                                32.02449311635436
                            ],
                            [
                                34.72565176327226,
                                32.02555856986957
                            ],
                            [
                                34.72874778327987,
                                32.02689096613963
                            ],
                            [
                                34.73141043949914,
                                32.02817477589111
                            ],
                            [
                                34.73396174326474,
                                32.02990997805381
                            ]
                            ],
                        "type": "LineString"
                    }
                }
            },
            layout: {
                'symbol-placement': 'line-center',
                'text-field': ["to-string", ["get", "type"]],
                'text-anchor': 'bottom', // Adjust text anchor as needed
                 // Adjust text anchor as needed
                'text-font':[
                    // "Avenir Light",
                    "Arial Unicode MS Regular"
                ], // Set the font to Avenir Light
                'text-size': 8, // Set the text size to 11
                // Other layout properties as needed
            },
            paint: {
                'text-color': '#93794E',
                // Paint properties for the text label                
                'text-opacity': 0.6,

            },
        });

        map.addLayer({
            id: 'Israel-label',
            type: 'symbol',
            source: {
                type: 'geojson',
                data: {
                    "type": "Feature",
                    "properties": {
                    "type": "Blue text ~ proportion of Jewish/Israeli-owned groves",
                    },
                    "geometry": {
                        "coordinates": [
                            [
                                34.74182961515416,
                                32.02309494074555
                            ],
                            [
                                34.74281513746253,
                                32.02436266901426
                            ],
                            [
                                34.74414049504952,
                                32.02563039728297
                            ],
                            [
                                34.746145523193775,
                                32.026725227525006
                            ],
                            [
                                34.7483544525042,
                                32.02735907741466
                            ],
                            [
                                34.752058657041474,
                                32.02750313252898
                            ],
                            [
                                34.75555896041257,
                                32.02735907741466
                            ],
                            [
                                34.75851552733762,
                                32.02686928618273
                            ],
                            [
                                34.76126819309411,
                                32.02620662761815
                            ],
                            [
                                34.76779303044415,
                                32.024593173544815
                            ],
                            [
                                34.775813143021026,
                                32.02228818985732
                            ],
                            [
                                34.78383325559784,
                                32.02044416115119
                            ]
                            ],
                        "type": "LineString"
                    }
                }
            },
            layout: {
                'symbol-placement': 'line-center',
                'text-field': ["to-string", ["get", "type"]],
                'text-anchor': 'bottom', // Adjust text anchor as needed
                 // Adjust text anchor as needed
                'text-font': [
                    // "Avenir Light",
                    "Arial Unicode MS Regular"
                ], // Set the font to Avenir Light
                'text-size': 8, // Set the text size to 11
                // Other layout properties as needed
            },
            paint: {
                'text-color': '#1d4b90',
                'text-opacity': 0.5,
                // Paint properties for the text label
            },
        });

        map.addLayer({
            id: 'Palestine-label',
            type: 'symbol',
            source: {
                type: 'geojson',
                data: {
                    "type": "Feature",
                    "properties": {
                    "type": "Green text ~ proportion of Palestinian-owned groves",
                    },
                    "geometry": {
                        "coordinates": [
                            [
                                34.77935217823621,
                                32.08062653543671
                            ],
                            [
                                34.77939415950419,
                                32.075721424606186
                            ],
                            [
                                34.77924892802766,
                                32.07346375779426
                            ],
                            [
                                34.77904668374374,
                                32.07178580913926
                            ],
                            [
                                34.77863223451447,
                                32.06995223807181
                            ],
                            [
                                34.77798260097674,
                                32.068367786112205
                            ],
                            [
                                34.77736723872577,
                                32.06736533546624
                            ],
                            [
                                34.77663428432044,
                                32.066562185834016
                            ],
                            [
                                34.7758039361524,
                                32.06572857331775
                            ],
                            [
                                34.774797199755,
                                32.06504443902476
                            ],
                            [
                                34.7736345559154,
                                32.06432369262561
                            ],
                            [
                                34.7724719120758,
                                32.06380225353788
                            ],
                            [
                                34.771098218403566,
                                32.063185026563715
                            ],
                            [
                                34.767320034466074,
                                32.06173733734373
                            ],
                            [
                                34.76344553293685,
                                32.06067272332335
                            ],
                            [
                                34.75850848920573,
                                32.05980936499518
                            ]
                            ],
                        "type": "LineString"
                    }
                }
            },
            layout: {
                'symbol-placement': 'line-center',
                'text-field': ["to-string", ["get", "type"]],
                'text-anchor': 'bottom', // Adjust text anchor as needed
                 // Adjust text anchor as needed
                'text-font':[
                    // "Avenir Light",
                    "Arial Unicode MS Regular"
                ], // Set the font to Avenir Light // Set the font to Avenir Light
                'text-size': 8, // Set the text size to 11
                'text-letter-spacing': 0.07,
                // Other layout properties as needed
            },
            paint: {
                'text-color': '#9DA47F',
                // Paint properties for the text label
            },
        });

        var circleFillLayer = map.getLayer("circle-fill");
        var circleOutlineLayer = map.getLayer("circle-outline");
        var chapterOutlines = {}; // Object to store chapter outlines

        function updateCircleRadiusAndStoreOutline(radius, response) {
            var center = turf.point([34.71060, 32.0686]);
            var options = {
                steps: 80,
                units: 'kilometers'
            };
            var newCircle = turf.circle(center, radius, options);

            if (map.getLayer('circle-fill')) {
                map.removeLayer('circle-fill');
                map.removeSource('circle-fill');
            }

            map.addLayer({
                "id": "circle-fill",
                "type": "fill",
                "source": {
                    "type": "geojson",
                    "data": newCircle
                },
                "paint": {
                    "fill-pattern": "newestOrangeBabe-01",
                    "fill-opacity": 1
                }
            });

            map.getSource("circle-fill").setData(newCircle);
            if (circleOutlines.length >4) {
                circleOutlines.length =4
            }

            circleOutlines.push(newCircle);
            circleOutlines.forEach((outline, index) => {
                var isActiveChapter = config.chapters[index].id === response.element.id;

                console.log(config.chapters[index].id)
                console.log(response.element.id)
                console.log(circleOutlines.length)
                // console.log(chapterOutlines.length)

                var lineOpacity = isActiveChapter ? 1 : 0.3; // Set opacity for inactive chapters
                var lineDashArray = isActiveChapter ? undefined : [5, 3]; // Set line dash for inactive chapters

                var layerId = 'circle-outline-' + index;
                var existingLayer = map.getLayer(layerId);

                // Check if the layer already exists and remove it before re-adding
                if (existingLayer) {
                    map.removeLayer(layerId);
                    map.removeSource(layerId);
                }

                // Ensure line dash array and opacity are properly handled based on their values
                var paintProperties = {
                    'line-color': '#9DA47F',
                    'line-opacity': lineOpacity, // Set opacity here
                    'line-width': isActiveChapter ? 3 : 3 * 0.5 // Set width for inactive chapters, reducing it to 75%

                };

                if (lineDashArray) {
                    paintProperties['line-dasharray'] = lineDashArray;
                }

                map.addLayer({
                    'id': layerId,
                    'type': 'line',
                    'source': {
                        'type': 'geojson',
                        'data': outline
                    },
                    'paint': paintProperties // Assign the paint properties
                });
                });
                }

        const responseObj = {
            element: {
                id: response.element.id // Assuming this is where 'id' is stored
                // Other properties if needed
            }
        };

        updateCircleRadiusAndStoreOutline(newRadius, responseObj);


        response.element.classList.add('active');
        map[chapter.mapAnimation || 'flyTo'](chapter.location);

        map.on('click', (event) => {
            const features = map.queryRenderedFeatures(event.point, { layers: ['places'] });
            if (!features.length) return;
            
            displayMarkersForChapter(chapter);
        });

        // Update the circle radius based on the chapter

        if (chapter.onChapterEnter.length > 0) {
            chapter.onChapterEnter.forEach(setLayerOpacity);
        }
        if (chapter.callback) {
            window[chapter.callback]();
        }
        if (config.auto) {
             var next_chapter = (current_chapter + 1) % config.chapters.length;
             map.once('moveend', () => {
                 document.querySelectorAll('[data-scrollama-index="' + next_chapter.toString() + '"]')[0].scrollIntoView();
             });
        }
    })
    
    .onStepExit(response => {
        const popUps = document.getElementsByClassName('mapboxgl-popup');
        while (popUps[0]) {
            popUps[0].remove();
        }
        var chapter = config.chapters.find(chap => chap.id === response.element.id);
        response.element.classList.remove('active');
        if (chapter.onChapterExit.length > 0) {
            chapter.onChapterExit.forEach(setLayerOpacity);
        }
    });

    if (config.auto) {
        document.querySelectorAll('[data-scrollama-index="0"]')[0].scrollIntoView();
    }
});

window.addEventListener('scroll', function() {
    var scrollTop = window.scrollY;
    var exposition = document.getElementById('exposition');
    var mapContainer = document.getElementById('map-container');

    if (scrollTop > exposition.offsetHeight) {
        exposition.classList.add('exposition-hidden');
        var mapTop = Math.max(0, exposition.offsetHeight - scrollTop);
        var mapHeight = Math.max(0, 100 - (scrollTop / window.innerHeight) * 100);
        mapContainer.style.top = mapTop + 'px';
        mapContainer.style.height = 'calc(' + mapHeight + 'vh)';
        mapContainer.style.position = 'fixed';
    } else {
        exposition.classList.remove('exposition-hidden');
        mapContainer.style.top = 0;
        mapContainer.style.height = '100vh';
        mapContainer.style.position = 'relative'; // Reset position to default
    }
});

const mapElement = document.getElementById('map');




document.addEventListener("DOMContentLoaded", function () {
    const markers = document.querySelectorAll(".timeline-marker");

    // Add click event listeners to timeline markers
    markers.forEach((marker, index) => {
        marker.addEventListener("click", () => {
            // Scroll to the corresponding chapter
            scrollToChapter(index+1);
        });
    });

    // Function to scroll to the corresponding chapter
    function scrollToChapter(step) {
        const chapters = document.querySelectorAll(".step");
        if (chapters[step]) {
            chapters[step].scrollIntoView({ behavior: "smooth" });
        }
    }
});

</script>
</body>
</html>