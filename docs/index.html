<!DOCTYPE html>
<html> 
<head>
    <meta charset='utf-8' />
    <title>Mapbox Storytelling</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/mapbox/assembly/publisher-staging/src/svgs/mapbox.svg">
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@600;800&display=swap" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Besley:wght@500&display=swap" rel="stylesheet"> -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/intersection-observer@0.12.0/intersection-observer.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://unpkg.com/scrollama"></script>
    <style>
        /* Add a new class to control visibility of the exposition */
        .exposition-hidden {
            display: none;
        }
        /* Sticky positioning for the exposition */
        #exposition {
            background-image: url('https://github.com/madgallop/jaffa-oranges/blob/main/docs/images/landing_place.jpg?raw=true');
            background-size: 60% auto; /* Makes the background image slightly smaller */
            background-origin: content-box; /* Preserves the background color within padding */
            background-clip: content-box; /* Applies the background within the padding */
            background-position: center;
            background-color: #f6f3eeb7; 
            background-repeat: no-repeat; /* Prevents the background image from repeating */
            background-attachment: fixed; /* Fixes the background position */
            text-align: center; /* Center the text */
            font-family: 'EB Garamond', serif; /* Use EB Garamond font */
            box-sizing: border-box;
            height: 96vh; /* Set the height to half the viewport height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 1000;
        }
        #map-container {
            position: flex;
            width: 100%;
            top: 0; 
            height: 100vh; /* Occupy the remaining viewport height */
            transition: height 0.3s ease; /* Add transition for smooth height change */
        }
        body {
            margin:0;
            padding:0;
            font-family: 'Avenir', sans-serif;
            font-weight: normal;
            opacity: 1;
            color: #4d4d4dec;
            text-align: justify;
        }
        #map {
            height: 100vh;
            width: 100%;
            position: absolute; /* Change to relative for proper placement */
            z-index: 0;
        }
        /* Adjustments for the exposition text */

        /* Font for title and subtitle */
        .h1-text{
            color: rgb(119, 118, 118);
            position: absolute;
            top: 0;
            left: 20.5%;
            padding: 2vh 1vw; /* Adjust the padding as needed */
            font-size: 20px; /* Adjust the font size as needed */
            text-align: center;
            font-weight: bold;
            font-family: 'EB+Garamond', serif;
            letter-spacing: 5px;
        }
        .p1-text{
            color: rgb(119, 118, 118);
            max-width: 30vh;
            position: absolute;
            top: 20vh;
            left: 5vh;
            padding: 8vh 7vw; /* Adjust the padding as needed */
            max-width: 50vh; /* Set the maximum width to 50% */
            margin: 0 auto; /* Center the element horizontally */
            font-size: 15px; /* Adjust the font size as needed */
            text-align: center;
            float:left;
            font-family: 'EB+Garamond', serif; /* Use correct font name */
            letter-spacing: 1px; 
            background-color: #dddbc8e0;
        }
        .p3-text {
            margin: 0;
            position:absolute;
            top:40vh;
            right: 7vh;
            color: rgb(119, 118, 118);
            max-width: 30vh;
            padding: 5vh 8vw;
            font-size: 14px; /* Adjust the font size as needed */
            text-align: center;
            float: right;
            font-family: 'EB+Garamond', serif;
            font-weight: lighter;
            background-color:#e7c094d7;
        }
        /* Font for chapters */
        .step h3 {
            font-family: 'Avenir', sans-serif;
            font-weight: normal;
            color: rgb(136, 136, 136);
            margin: 0;
            padding: 0.5vh 0.2vw; /* Adjust the padding as needed */
            text-align: left;
            font-size: 12px;
            width: 50%; /* Set the width to 50% */
            text-align: left;
            letter-spacing: 0px; 
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        /* Active class for fade-in */
        .step.active h3 {
            transition: opacity 1s ease;
            opacity: 1;
        }
        #timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100vw;
            margin: 60px 5px;
            position: fixed;
            bottom: 0;
            z-index: 2;
        }
        .timeline-marker {
            background: #EFBF8F;
            width: 20px;
            margin: 10px 25px;
            height: 20px;
            border-radius: 50vw;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            font-family: 'EB+Garamond', serif;
            color: rgb(119, 118, 118);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 2;
        }
        .timeline-marker:hover {
            background: #f6a14c;
        }
        /* Example CSS to highlight the active timeline marker */
        .timeline-marker.active-timeline-marker {
            background-color: #f9912a; /* Change the color as desired */
            /* Add any other styles to visually highlight the active marker */
        }
        .text-container {
            background-color: rgba(238, 237, 237, 0); /* Background color for the text */
            padding: 10px; /* Adjust the padding as needed */
            border-radius: 0; /* Adjust border radius as needed */
            z-index: -1;
        }
        .timeline-line {
            position: fixed;
            background-color: #EFBF8F;
            height: 3px; /* Adjust the height of the line as needed */
            width: calc(100% - 75px); /* Width of the line is the container width minus marker margins */
            transform: translateY(-1px); /* Center the line vertically */
            left: 20px;
            right:10px;
            margin: 10px 25px;
            z-index: 0; /* Place the line behind markers */
        }
        #scale-bar {
            position: fixed;
            bottom: 0;            
            margin: 3px 140px;
            background: rgba(255, 255, 255, 0);
            border: 2px solid #EFBF8F;
            padding: 5px 27px;
            font-size: 12px;
            font-family: 'EB+Garamond', serif;
            color: rgb(119, 118, 118);
        }
        #mapInset {
            bottom:50px;
            right:30px;
            height: 80px; /* Example height */
            width: 120px; /* Example width */
            max-width:100%;
            position: fixed;
            z-index: 1;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            display: none;
        }
        #insetCanvas {
            position: absolute;
            top: 65vh;
            left: 8vh; 
            height: auto;
            width: 180px;
            border: 1px solid #ccc;
            float:right;
            opacity: 90%;
        }
        .inset-map {
            width: 100%; /* Set width to 100% */
            text-align: right; /* Center the image horizontally */
            padding: 20px; /* Add padding as needed */
            float:right;
        }
        #inset-map-image {
            max-width: 100%; /* Ensure the image doesn't exceed its container */
            max-height: 100%; /* Ensure the image doesn't exceed its container */
            width: auto; /* Allow the image to adjust its width */
            height: auto; /* Allow the image to adjust its height */
            border: 1px solid #ccc; /* Optional: Add border for visibility */
            float: right;
        /* You can adjust other styles as needed */
        }

        /* #mapInset .mapboxgl-ctrl-bottom-left{
            display: none;
        }
        @media (max-width: 500px) {
            #mapInset {
                display: none;
            }
        } */
        #footer {
            width: 100%;
            min-height: 5vh;
            padding-top: 2vh;
            padding-bottom: 2vh;
            text-align: center;
            line-height: 25px;
            font-size: 13px;
            position: relative;
            z-index: 5;
        }
        #features {
            padding-top: 10vh;
            padding-bottom: 10vh;
        }
        .hidden {
            visibility: hidden;
        }
        .centered {
            width: 50vw;
            margin: 0 auto;
        }
        .lefty {
            width: 33vw;
            margin-left: 2vw;
        }
        .righty {
            width: 33vw;
            margin-left: 62vw;
        }
        .fully {
            width: 100%;
            margin: auto;
        }
        .light {
            color: #444;
            background-color: #fafafa00;
        }
        .dark {
            color: #fafafa;
            background-color: #444;
        }
        .step {
            padding-bottom: 50vh;
            /* margin-bottom: 10vh; */
            opacity: 0;
            transition: opacity 1s ease; /* Add transition effect over 2 seconds */
        }
        .step.active {
            transition: opacity 1s ease-in-out;
            opacity: 0.9;
        }

        .step div {
            padding:  25px 0px;
            line-height: 25px;
            font-size: 13px;
        }

        .step img {
            width: 100%;
        }

        @media (max-width: 750px) {
            .centered, .lefty, .righty, .fully {
                display: none;
                width: 90vw;
                margin: 0 auto;
            }
        }

        /* Fix issue on mobile browser where scroll breaks  */
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan .mapboxgl-canvas {
            touch-action: unset;
        }

        </style>
</head>
<body>

<div id="exposition" class="exposition-hidden">
    <div class="title-text">
        <h1 class="h1-text">THE PERFECT BITE:<br> COLLABORATION AND DISPOSSESSION IN JAFFA, PALESTINE</h1>
        <p class="p1-text">The Jaffa orange was once Palestine's primary export and strong symbol of identity. While Palestinian farmers collaborated with Jewish settlers for decades, after the Nakba, or, in English, "Catastrophe" of 1948, Israeli settlers took the industry over, and as Israel's population expanded, the orange industry declined. The maps below trace the story of the orange, from its early, Palestinian dominated days, until its final collapse in the late 20th century.</p>
        <canvas id="insetCanvas"></canvas>
        <p class="p3-text"> Scroll through time or select on of the three defining periods of the Jaffa orange on the timeline below.<br><br><i>Note: circle radius = total area of Jaffa orange groves/total boxes of Jaffa oranges exported.</i></p>
    </div>
</div>
<div id="map-container">
    <div id="map"></div>
</div>
<div id="scale-bar" class="mapboxgl-ctrl mapboxgl-ctrl-scale">
    <span>1km</span>
</div>
<div id="timeline">
    <div class="timeline-marker" data-chapter="0">
        <div class="text-container">
            <p id="chapter-1-text">Palestinian Period</p>
        </div>
    </div>
    <div class="timeline-marker" data-chapter="1">
        <div class="text-container">
            <p id="chapter-1-text">Collaborative Period</p>
        </div>
    </div>
    <div class="timeline-marker" data-chapter="2">
        <div class="text-container">
            <p id="chapter-1-text">Israeli Period</p>
        </div>
    </div>
    <div class="timeline-line"></div>
</div>
<div id="mapInset"></div>
<div id="story"></div>
  

<script src="./config.js"></script>
<script>
var initLoad = true;
var layerTypes = {
    'fill': ['fill-opacity'],
    'line': ['line-opacity'],
    'circle': ['circle-opacity', 'circle-stroke-opacity'],
    'symbol': ['icon-opacity', 'text-opacity'],
    'raster': ['raster-opacity'],
    'fill-extrusion': ['fill-extrusion-opacity'],
    'heatmap': ['heatmap-opacity']
}

var alignments = {
    'left': 'lefty',
    'center': 'centered',
    'right': 'righty',
    'full': 'fully'
}

function getLayerPaintType(layer) {
    var layerType = map.getLayer(layer).type;
    return layerTypes[layerType];
}

function setLayerOpacity(layer) {
    var paintProps = getLayerPaintType(layer.layer);
    paintProps.forEach(function(prop) {
        var options = {};
        if (layer.duration) {
            var transitionProp = prop + "-transition";
            options = { "duration": layer.duration };
            map.setPaintProperty(layer.layer, transitionProp, options);
        }
        map.setPaintProperty(layer.layer, prop, layer.opacity, options);
    });
}

var story = document.getElementById('story');
var features = document.createElement('div');
features.setAttribute('id', 'features');

config.chapters.forEach((record, idx) => {
    var container = document.createElement('div');
    var chapter = document.createElement('div');

    if (record.title) {
        var title = document.createElement('h3');
        title.innerText = record.title;
        chapter.appendChild(title);
    }

    if (record.image) {
        var image = new Image();
        image.src = record.image;
        chapter.appendChild(image);
    }

    if (record.description) {
        var story = document.createElement('p');
        story.innerHTML = record.description;
        chapter.appendChild(story);
    }

    container.setAttribute('id', record.id);
    container.classList.add('step');
    if (idx === 0) {
        container.classList.add('active');
    }

    chapter.classList.add(config.theme);
    container.appendChild(chapter);
    container.classList.add(alignments[record.alignment] || 'centered');
    if (record.hidden) {
        container.classList.add('hidden');
    }
    features.appendChild(container);
});

story.appendChild(features);

var footer = document.createElement('div');

if (config.footer) {
    var footerText = document.createElement('p');
    footerText.innerHTML = config.footer;
    footer.appendChild(footerText);
}

if (footer.innerText.length > 0) {
    footer.classList.add(config.theme);
    footer.setAttribute('id', 'footer');
    story.appendChild(footer);
}

mapboxgl.accessToken = config.accessToken;

const transformRequest = (url) => {
    const hasQuery = url.indexOf("?") !== -1;
    const suffix = hasQuery ? "&pluginName=scrollytellingV2" : "?pluginName=scrollytellingV2";
    return {
      url: url + suffix
    }
}

var map = new mapboxgl.Map({
    container: 'map',
    style: config.style,
    center: config.chapters[0].location.center,
    zoom: config.chapters[0].location.zoom,
    bearing: config.chapters[0].location.bearing,
    pitch: config.chapters[0].location.pitch,
    interactive: false,
    transformRequest: transformRequest,
    projection: config.projection
});

// Create a inset map if enabled in config.js
if (config.inset) {
 var insetMap = new mapboxgl.Map({
    container: 'mapInset', // container id
    style: 'mapbox://styles/madgallop/clpekqaqe006801p79o6x0yic', //hosted style id
    center: config.chapters[0].location.center,
    // Hardcode above center value if you want insetMap to be static.
    zoom: 5.5, // starting zoom
    hash: false,
    interactive: false,
    attributionControl: false
  });
}


// instantiate the scrollama
var scroller = scrollama();

map.on("load", function() {
    insetMap.on("load", function() {
        var insetCanvas = document.getElementById('insetCanvas')
        var insetContext = insetCanvas.getContext('2d');
        var insetMapCanvas = insetMap.getCanvas();
        insetCanvas.width = insetMapCanvas.width;
        insetCanvas.height = insetMapCanvas.height;

        // Capture the inset map onto the canvas
        insetContext.drawImage(insetMap.getCanvas(), 0, 0)

        // Convert the canvas to a data URL
        // var imgURL = insetCanvas.toDataURL('image/png');

        // // Create an image element and set its source to the data URL
        // var img = document.createElement('img');
        // img.src = imgURL;
        // img.id = 'inset-map-image';
        // document.querySelector('.inset-map').appendChild(img);
    });

    // setup the instance, pass callback functions
    scroller
    .setup({
        step: '.step',
        offset: 0.5,
        progress: true
    })
    
    .onStepEnter(async response => {
        var initialCircleRadius = 2; // Initial radius in kilometers
        var currentCircleRadius = initialCircleRadius;
        var maxRadiusChange = 8; // Maximum change in radius

        var center = turf.point([34.71250, 32.07967]);
        var options = {
        steps: 80,
        units: 'kilometers'
        };

        var circle = turf.circle(center, initialCircleRadius, options);
        document.getElementById("exposition").classList.add("exposition-hidden");

        map.addLayer({
            "id": "circle-fill",
            "type": "fill",
            "source": {
                "type": "geojson",
                "data": circle
            },
            "paint": {
                "fill-pattern": "newestOrangeBabe-01",
                "fill-opacity": 1
            }
        });

        map.addLayer({
            "id": "circle-outline",
            "type": "line",
            "source": {
                "type": "geojson",
                "data": circle
            },
            "paint": {
                "line-color": "#9DA47F",
                "line-opacity": 0.5,
                "line-width": 3,
            }
        });

        var circleFillLayer = map.getLayer("circle-fill");
        var circleOutlineLayer = map.getLayer("circle-outline");

        // Function to update the circle's radius
        function updateCircleRadius(radius) {
            currentCircleRadius = radius;
            var newCircle = turf.circle(center, currentCircleRadius, options);
            map.getSource("circle-fill").setData(newCircle);
            map.getSource("circle-outline").setData(newCircle);
        }
        var current_chapter = config.chapters.findIndex(chap => chap.id === response.element.id);

        document.querySelectorAll('.timeline-marker').forEach(marker => {
            marker.classList.remove('active-timeline-marker');
        });

        // Add active class to the corresponding timeline marker
        var currentTimelineMarker = document.querySelector(`.timeline-marker[data-chapter="${current_chapter}"]`);
        if (currentTimelineMarker) {
            currentTimelineMarker.classList.add('active-timeline-marker');
        }

        var chapter = config.chapters[current_chapter];

        response.element.classList.add('active');
        map[chapter.mapAnimation || 'flyTo'](chapter.location);

        // Update the circle radius based on the chapter
        var newRadius = initialCircleRadius + (current_chapter * 2); // Adjust the increment as needed
        updateCircleRadius(newRadius);

        if (chapter.onChapterEnter.length > 0) {
            chapter.onChapterEnter.forEach(setLayerOpacity);
        }
        if (chapter.callback) {
            window[chapter.callback]();
        }
        if (config.auto) {
             var next_chapter = (current_chapter + 1) % config.chapters.length;
             map.once('moveend', () => {
                 document.querySelectorAll('[data-scrollama-index="' + next_chapter.toString() + '"]')[0].scrollIntoView();
             });
        }
    })
    .onStepExit(response => {
        var chapter = config.chapters.find(chap => chap.id === response.element.id);
        response.element.classList.remove('active');
        if (chapter.onChapterExit.length > 0) {
            chapter.onChapterExit.forEach(setLayerOpacity);
        }
    });

    if (config.auto) {
        document.querySelectorAll('[data-scrollama-index="0"]')[0].scrollIntoView();
    }
});

window.addEventListener('scroll', function() {
    var scrollTop = window.scrollY;
    var exposition = document.getElementById('exposition');
    var mapContainer = document.getElementById('map-container');

    if (scrollTop > exposition.offsetHeight) {
        exposition.classList.add('exposition-hidden');
        var mapTop = Math.max(0, exposition.offsetHeight - scrollTop);
        var mapHeight = Math.max(0, 100 - (scrollTop / window.innerHeight) * 100);
        mapContainer.style.top = mapTop + 'px';
        mapContainer.style.height = 'calc(' + mapHeight + 'vh)';
        mapContainer.style.position = 'fixed';
    } else {
        exposition.classList.remove('exposition-hidden');
        mapContainer.style.top = 0;
        mapContainer.style.height = '100vh';
        mapContainer.style.position = 'relative'; // Reset position to default
    }
});

document.addEventListener("DOMContentLoaded", function () {
    const markers = document.querySelectorAll(".timeline-marker");

    // Add click event listeners to timeline markers
    markers.forEach((marker, index) => {
        marker.addEventListener("click", () => {
            // Scroll to the corresponding chapter
            scrollToChapter(index);
        });
    });

    // Function to scroll to the corresponding chapter
    function scrollToChapter(step) {
        const chapters = document.querySelectorAll(".step");
        if (chapters[step]) {
            chapters[step].scrollIntoView({ behavior: "smooth" });
        }
    }
});

</script>
</body>
</html>
